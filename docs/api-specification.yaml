openapi: 3.0.3
info:
  title: LLM-Incident-Manager API
  description: |
    REST API for the LLM-Incident-Manager system. This API provides comprehensive
    incident management capabilities including event ingestion, incident lifecycle
    management, routing, notifications, and analytics.

    ## Authentication
    All API requests require authentication using one of the following methods:
    - API Key (Header: `X-API-Key`)
    - Bearer Token (Header: `Authorization: Bearer <token>`)
    - OAuth 2.0

    ## Rate Limiting
    API requests are rate-limited based on your subscription:
    - Free: 100 requests/minute
    - Standard: 1,000 requests/minute
    - Enterprise: 10,000 requests/minute

    Rate limit headers are included in all responses:
    - `X-RateLimit-Limit`: Request limit per window
    - `X-RateLimit-Remaining`: Remaining requests
    - `X-RateLimit-Reset`: Unix timestamp when limit resets

    ## Pagination
    List endpoints support cursor-based pagination:
    - `page`: Page number (default: 1)
    - `page_size`: Results per page (default: 50, max: 100)

  version: 1.0.0
  contact:
    name: LLM-Incident-Manager Support
    email: support@example.com
    url: https://docs.example.com/incident-manager
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://incidents.example.com/api/v1
    description: Production server
  - url: https://incidents-staging.example.com/api/v1
    description: Staging server
  - url: http://localhost:3000/api/v1
    description: Local development

tags:
  - name: Events
    description: Event ingestion endpoints
  - name: Incidents
    description: Incident management
  - name: Routing
    description: Routing and escalation
  - name: Notifications
    description: Notification management
  - name: Policies
    description: Policy configuration
  - name: Analytics
    description: Metrics and analytics
  - name: Users
    description: User management
  - name: Teams
    description: Team management
  - name: Health
    description: Health and status endpoints

paths:
  # ============================================================================
  # HEALTH & STATUS
  # ============================================================================

  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Returns the health status of the API
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded, unhealthy]
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                  uptime:
                    type: number
                    description: Uptime in seconds
                  components:
                    type: object
                    properties:
                      database:
                        type: string
                        enum: [up, down]
                      cache:
                        type: string
                        enum: [up, down]
                      message_queue:
                        type: string
                        enum: [up, down]

  /ready:
    get:
      tags: [Health]
      summary: Readiness check
      description: Returns whether the service is ready to accept traffic
      operationId: getReady
      responses:
        '200':
          description: Service is ready
        '503':
          description: Service is not ready

  /metrics:
    get:
      tags: [Health]
      summary: Prometheus metrics
      description: Returns metrics in Prometheus format
      operationId: getMetrics
      responses:
        '200':
          description: Metrics
          content:
            text/plain:
              schema:
                type: string

  # ============================================================================
  # EVENTS
  # ============================================================================

  /events:
    post:
      tags: [Events]
      summary: Create event
      description: Submit a new event for processing
      operationId: createEvent
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEventRequest'
      responses:
        '202':
          description: Event accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateEventResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '429':
          description: Rate limit exceeded

  /events/sentinel:
    post:
      tags: [Events]
      summary: Create event from Sentinel
      description: Submit event from LLM-Sentinel
      operationId: createSentinelEvent
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SentinelEvent'
      responses:
        '202':
          description: Event accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateEventResponse'

  /events/shield:
    post:
      tags: [Events]
      summary: Create event from Shield
      description: Submit event from LLM-Shield
      operationId: createShieldEvent
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShieldEvent'
      responses:
        '202':
          description: Event accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateEventResponse'

  /events/{eventId}:
    get:
      tags: [Events]
      summary: Get event
      description: Retrieve event by ID
      operationId: getEvent
      security:
        - ApiKeyAuth: []
      parameters:
        - name: eventId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Event details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '404':
          description: Event not found

  # ============================================================================
  # INCIDENTS
  # ============================================================================

  /incidents:
    get:
      tags: [Incidents]
      summary: List incidents
      description: List incidents with filtering and pagination
      operationId: listIncidents
      security:
        - ApiKeyAuth: []
      parameters:
        - name: severity
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/Severity'
        - name: status
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/IncidentStatus'
        - name: category
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/Category'
        - name: environment
          in: query
          schema:
            $ref: '#/components/schemas/Environment'
        - name: start_date
          in: query
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          schema:
            type: string
            format: date-time
        - name: search
          in: query
          description: Search query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: sort
          in: query
          schema:
            type: string
            enum: [created_at, updated_at, severity, status]
            default: created_at
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: List of incidents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentList'

    post:
      tags: [Incidents]
      summary: Create incident
      description: Create incident directly (bypassing event ingestion)
      operationId: createIncident
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateIncidentRequest'
      responses:
        '201':
          description: Incident created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

  /incidents/{incidentId}:
    get:
      tags: [Incidents]
      summary: Get incident
      description: Retrieve incident by ID
      operationId: getIncident
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Incident details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'
        '404':
          description: Incident not found

    patch:
      tags: [Incidents]
      summary: Update incident
      description: Update incident fields
      operationId: updateIncident
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateIncidentRequest'
      responses:
        '200':
          description: Incident updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

  /incidents/{incidentId}/acknowledge:
    post:
      tags: [Incidents]
      summary: Acknowledge incident
      description: Acknowledge incident
      operationId: acknowledgeIncident
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notes:
                  type: string
      responses:
        '200':
          description: Incident acknowledged
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

  /incidents/{incidentId}/resolve:
    post:
      tags: [Incidents]
      summary: Resolve incident
      description: Mark incident as resolved
      operationId: resolveIncident
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [resolution_notes]
              properties:
                root_cause:
                  type: string
                resolution_notes:
                  type: string
                playbook_used:
                  type: string
      responses:
        '200':
          description: Incident resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

  /incidents/{incidentId}/close:
    post:
      tags: [Incidents]
      summary: Close incident
      description: Close incident after post-mortem
      operationId: closeIncident
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                post_mortem_url:
                  type: string
                  format: uri
                notes:
                  type: string
      responses:
        '200':
          description: Incident closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

  /incidents/{incidentId}/escalate:
    post:
      tags: [Incidents]
      summary: Escalate incident
      description: Manually escalate incident
      operationId: escalateIncident
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                escalate_to:
                  type: string
      responses:
        '200':
          description: Incident escalated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

  /incidents/{incidentId}/timeline:
    get:
      tags: [Incidents]
      summary: Get incident timeline
      description: Get complete timeline of incident events
      operationId: getIncidentTimeline
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Incident timeline
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TimelineEvent'

  /incidents/{incidentId}/comments:
    get:
      tags: [Incidents]
      summary: Get comments
      description: Get all comments for incident
      operationId: getIncidentComments
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Comments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Comment'

    post:
      tags: [Incidents]
      summary: Add comment
      description: Add comment to incident
      operationId: addIncidentComment
      security:
        - ApiKeyAuth: []
      parameters:
        - name: incidentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        '201':
          description: Comment added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

  # ============================================================================
  # ANALYTICS
  # ============================================================================

  /analytics/metrics:
    get:
      tags: [Analytics]
      summary: Get incident metrics
      description: Get aggregated incident metrics
      operationId: getIncidentMetrics
      security:
        - ApiKeyAuth: []
      parameters:
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: group_by
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [severity, category, status, team]
      responses:
        '200':
          description: Incident metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentMetrics'

  /analytics/trends:
    get:
      tags: [Analytics]
      summary: Get incident trends
      description: Get incident trends over time
      operationId: getIncidentTrends
      security:
        - ApiKeyAuth: []
      parameters:
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: interval
          in: query
          schema:
            type: string
            enum: [hour, day, week, month]
            default: day
      responses:
        '200':
          description: Incident trends
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TrendDataPoint'

  # ============================================================================
  # POLICIES
  # ============================================================================

  /policies/escalation:
    get:
      tags: [Policies]
      summary: List escalation policies
      description: List all escalation policies
      operationId: listEscalationPolicies
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Escalation policies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EscalationPolicy'

    post:
      tags: [Policies]
      summary: Create escalation policy
      description: Create new escalation policy
      operationId: createEscalationPolicy
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEscalationPolicyRequest'
      responses:
        '201':
          description: Escalation policy created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscalationPolicy'

  /policies/escalation/{policyId}:
    get:
      tags: [Policies]
      summary: Get escalation policy
      description: Get escalation policy by ID
      operationId: getEscalationPolicy
      security:
        - ApiKeyAuth: []
      parameters:
        - name: policyId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Escalation policy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscalationPolicy'

# ============================================================================
# COMPONENTS
# ============================================================================

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Common Types
    Severity:
      type: string
      enum: [P0, P1, P2, P3, P4]
      description: |
        - P0: Critical (system down, data breach)
        - P1: High (degraded performance, partial outage)
        - P2: Medium (minor issues, isolated failures)
        - P3: Low (warnings, non-critical alerts)
        - P4: Info (informational, monitoring data)

    IncidentStatus:
      type: string
      enum: [NEW, ACKNOWLEDGED, IN_PROGRESS, ESCALATED, RESOLVED, CLOSED]

    Category:
      type: string
      enum: [performance, security, availability, compliance, cost, other]

    Environment:
      type: string
      enum: [production, staging, development, qa]

    # Event Schemas
    CreateEventRequest:
      type: object
      required: [source, timestamp, event_type, category, title, description, severity]
      properties:
        event_id:
          type: string
        source:
          type: string
        source_version:
          type: string
        timestamp:
          type: string
          format: date-time
        event_type:
          type: string
        category:
          $ref: '#/components/schemas/Category'
        title:
          type: string
        description:
          type: string
        severity:
          type: string
        resource:
          $ref: '#/components/schemas/Resource'
        metrics:
          type: object
          additionalProperties:
            type: number
        tags:
          type: object
          additionalProperties:
            type: string
        payload:
          type: object

    CreateEventResponse:
      type: object
      properties:
        status:
          type: string
          enum: [accepted, duplicate]
        event_id:
          type: string
        incident_id:
          type: string
        duplicate_of:
          type: string
        message:
          type: string
        links:
          type: object
          properties:
            incident:
              type: string
              format: uri
            api:
              type: string
              format: uri

    Event:
      type: object
      properties:
        event_id:
          type: string
        source:
          type: string
        timestamp:
          type: string
          format: date-time
        event_type:
          type: string
        category:
          $ref: '#/components/schemas/Category'
        title:
          type: string
        description:
          type: string
        severity:
          type: string
        resource:
          $ref: '#/components/schemas/Resource'
        metrics:
          type: object
        tags:
          type: object
        fingerprint:
          type: string
        incident_id:
          type: string

    SentinelEvent:
      allOf:
        - $ref: '#/components/schemas/CreateEventRequest'
        - type: object
          properties:
            source:
              type: string
              enum: [llm-sentinel]

    ShieldEvent:
      allOf:
        - $ref: '#/components/schemas/CreateEventRequest'
        - type: object
          properties:
            source:
              type: string
              enum: [llm-shield]

    # Incident Schemas
    Incident:
      type: object
      properties:
        id:
          type: string
        external_id:
          type: string
        fingerprint:
          type: string
        severity:
          $ref: '#/components/schemas/Severity'
        status:
          $ref: '#/components/schemas/IncidentStatus'
        category:
          $ref: '#/components/schemas/Category'
        title:
          type: string
        description:
          type: string
        impact:
          type: string
        source:
          type: string
        source_event_id:
          type: string
        assigned_to:
          type: string
        assigned_team:
          type: string
        escalation_level:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        acknowledged_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time
        closed_at:
          type: string
          format: date-time
        sla:
          $ref: '#/components/schemas/SLA'
        related_incidents:
          type: array
          items:
            type: string
        metrics:
          $ref: '#/components/schemas/Metrics'
        resource:
          $ref: '#/components/schemas/Resource'
        environment:
          $ref: '#/components/schemas/Environment'
        tags:
          type: object
          additionalProperties:
            type: string
        resolution:
          $ref: '#/components/schemas/Resolution'

    CreateIncidentRequest:
      type: object
      required: [title, severity, category, description]
      properties:
        title:
          type: string
        description:
          type: string
        severity:
          $ref: '#/components/schemas/Severity'
        category:
          $ref: '#/components/schemas/Category'
        impact:
          type: string
        resource:
          $ref: '#/components/schemas/Resource'
        environment:
          $ref: '#/components/schemas/Environment'
        tags:
          type: object

    UpdateIncidentRequest:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        severity:
          $ref: '#/components/schemas/Severity'
        status:
          $ref: '#/components/schemas/IncidentStatus'
        assigned_to:
          type: string
        assigned_team:
          type: string
        tags:
          type: object

    IncidentList:
      type: object
      properties:
        incidents:
          type: array
          items:
            $ref: '#/components/schemas/Incident'
        pagination:
          $ref: '#/components/schemas/Pagination'

    # Supporting Schemas
    Resource:
      type: object
      properties:
        type:
          type: string
        id:
          type: string
        name:
          type: string
        metadata:
          type: object

    SLA:
      type: object
      properties:
        acknowledgment_deadline:
          type: string
          format: date-time
        resolution_deadline:
          type: string
          format: date-time
        acknowledgment_breached:
          type: boolean
        resolution_breached:
          type: boolean

    Metrics:
      type: object
      properties:
        mttd:
          type: number
          description: Mean time to detect (seconds)
        mtta:
          type: number
          description: Mean time to acknowledge (seconds)
        mttr:
          type: number
          description: Mean time to resolve (seconds)

    Resolution:
      type: object
      properties:
        root_cause:
          type: string
        resolution_notes:
          type: string
        resolved_by:
          type: string
        playbook_used:
          type: string
        actions_taken:
          type: array
          items:
            $ref: '#/components/schemas/Action'

    Action:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        description:
          type: string
        executed_by:
          type: string
        executed_at:
          type: string
          format: date-time
        result:
          type: string

    TimelineEvent:
      type: object
      properties:
        id:
          type: string
        timestamp:
          type: string
          format: date-time
        event_type:
          type: string
        description:
          type: string
        actor:
          $ref: '#/components/schemas/Actor'

    Comment:
      type: object
      properties:
        id:
          type: string
        incident_id:
          type: string
        content:
          type: string
        author:
          $ref: '#/components/schemas/Actor'
        created_at:
          type: string
          format: date-time

    Actor:
      type: object
      properties:
        type:
          type: string
          enum: [user, system, integration]
        id:
          type: string
        name:
          type: string

    # Analytics Schemas
    IncidentMetrics:
      type: object
      properties:
        time_range:
          $ref: '#/components/schemas/TimeRange'
        total_incidents:
          type: integer
        incidents_by_severity:
          type: object
          additionalProperties:
            type: integer
        incidents_by_category:
          type: object
          additionalProperties:
            type: integer
        average_mttd:
          type: number
        average_mtta:
          type: number
        average_mttr:
          type: number
        sla_compliance:
          type: number
          description: Percentage (0-100)

    TrendDataPoint:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        value:
          type: number
        metadata:
          type: object

    TimeRange:
      type: object
      properties:
        start:
          type: string
          format: date-time
        end:
          type: string
          format: date-time

    # Policy Schemas
    EscalationPolicy:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        conditions:
          $ref: '#/components/schemas/EscalationConditions'
        levels:
          type: array
          items:
            $ref: '#/components/schemas/EscalationLevel'
        timers:
          $ref: '#/components/schemas/EscalationTimers'
        enabled:
          type: boolean
        priority:
          type: integer

    EscalationConditions:
      type: object
      properties:
        severity:
          type: array
          items:
            $ref: '#/components/schemas/Severity'
        category:
          type: array
          items:
            $ref: '#/components/schemas/Category'
        source:
          type: array
          items:
            type: string
        tags:
          type: object

    EscalationLevel:
      type: object
      properties:
        level:
          type: integer
        name:
          type: string
        targets:
          type: array
          items:
            $ref: '#/components/schemas/EscalationTarget'
        escalate_after:
          type: integer
          description: Seconds
        notification_channels:
          type: array
          items:
            type: string

    EscalationTarget:
      type: object
      properties:
        type:
          type: string
          enum: [user, team, on_call, external]
        id:
          type: string

    EscalationTimers:
      type: object
      properties:
        acknowledgment_timeout:
          type: integer
        resolution_timeout:
          type: integer
        escalation_interval:
          type: integer

    CreateEscalationPolicyRequest:
      type: object
      required: [name, conditions, levels]
      properties:
        name:
          type: string
        description:
          type: string
        conditions:
          $ref: '#/components/schemas/EscalationConditions'
        levels:
          type: array
          items:
            $ref: '#/components/schemas/EscalationLevel'

    # Common
    Pagination:
      type: object
      properties:
        page:
          type: integer
        page_size:
          type: integer
        total_count:
          type: integer
        total_pages:
          type: integer
        has_next:
          type: boolean
        has_previous:
          type: boolean

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
        timestamp:
          type: string
          format: date-time
